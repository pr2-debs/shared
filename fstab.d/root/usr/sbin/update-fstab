#!/bin/sh
# Script for flexible /etc/fstab.d configuration
# From Atha, with a lot of improvements from truc - thanks!
#
# You can find information on how to use this script at
# http://forums.gentoo.org/viewtopic.php?p=6364143
#
# This script idealy goes into /usr/local/bin and is called update-fstab -
# you need to configure your fstab entries in separate files in /etc/fstab.d;
# only filenames starting with two digits are included!
# Examples: /etc/fstab.d/01base or /etc/fstab.d/61nfs-dm8000, to name just two.
#
# Copyright 2008 Atha
# Distributed under the terms of the GNU General Public License v2 or later

# Bail on errors
set -e

## SETUP
# fstabdpath sets the path where the individual fstab file are located, this should normaly be /etc/fstab.d.
fstabdpath="/etc/fstab.d"
# tmppath sets the path where fstab will create its intermediate file
tmppath="/var/tmp/fstab.d"
# fstabdverbose sets the verbosity level. Default is 0 (no messages). If you want verbose output (i.e. to debug) set this to 1.
fstabdverbose="1"

## FUNCTIONS
message () {
  [ ${fstabdverbose} -gt 0 ] && echo $@ || :
}


## MAIN PROGRAM
if [ ! -d ${fstabdpath} ] ; then
  echo "update-fstab: ${fstabdpath} is not present!" >&2
  exit 1
fi

if [ -e ${fstabdpath}/fstab ] ; then
  echo "update-fstab: please remove ${fstabdpath}/fstab before you run this script.
update-fstab: NOTE: It may have been left by a previously run update-fstab, but you should check anyway." >&2
  exit 1
fi

cat << 'EOT' > ${tmppath} && message "${tmppath} created, header added"
# /etc/fstab
# automatically generated by the update-fstab script
#
# Please change the according lines in /etc/fstab.d/* if you want them to be permanent,
# otherwise they will not survive the next invocation of update-fstab!
#
EOT

for fstab_file in ${fstabdpath}/*; do
    if basename $fstab_file | grep -q "^[0-9][0-9][^~]*$"; then
	message "Adding: ${fstab_file}"
	grep '^[^#].*' ${fstab_file} >> ${tmppath} || :
    fi
done

# touch fstab.d.bak to support possible case of dangling symlink
touch /etc/fstab
touch /etc/fstab.d.bak
cp /etc/fstab /etc/fstab.d.bak && message "Existing /etc/fstab copied to /etc/fstab.d.bak"
cp ${tmppath} /etc/fstab && message "New file system table ${tmppath} copied to /etc/fstab"

exit 0
